<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <meta name="generator" content="sphinx-5.1.1, furo 2022.06.21"/>
        <title>dcm.net - dcm 0.1.0-dev documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=40978830699223671f4072448e654b5958f38b89" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">dcm 0.1.0-dev documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">dcm 0.1.0-dev documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">README</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../modules.html">API</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../dcm.html">dcm package</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../dcm.store.html">dcm.store package</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../dcm.store.base.html">dcm.store.base module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dcm.store.local_dir.html">dcm.store.local_dir module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../dcm.store.net_repo.html">dcm.store.net_repo module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../dcm.cli.html">dcm.cli module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dcm.conf.html">dcm.conf module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dcm.diff.html">dcm.diff module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dcm.filt.html">dcm.filt module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dcm.info.html">dcm.info module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dcm.lazyset.html">dcm.lazyset module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dcm.net.html">dcm.net module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dcm.normalize.html">dcm.normalize module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dcm.query.html">dcm.query module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dcm.report.html">dcm.report module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dcm.route.html">dcm.route module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dcm.sync.html">dcm.sync module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dcm.util.html">dcm.util module</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for dcm.net</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;High level async DICOM networking interface</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">asyncio</span><span class="o">,</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">enum</span><span class="o">,</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">asynccontextmanager</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">FrozenSet</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">AsyncIterator</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Awaitable</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">indent</span>

<span class="kn">import</span> <span class="nn">janus</span>
<span class="kn">from</span> <span class="nn">fifolock</span> <span class="kn">import</span> <span class="n">FifoLock</span>
<span class="kn">import</span> <span class="nn">pydicom</span>
<span class="kn">from</span> <span class="nn">pydicom.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">FileMetaDataset</span>
<span class="kn">from</span> <span class="nn">pydicom.datadict</span> <span class="kn">import</span> <span class="n">keyword_for_tag</span>

<span class="kn">from</span> <span class="nn">pynetdicom</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AE</span><span class="p">,</span>
    <span class="n">Association</span><span class="p">,</span>
    <span class="n">evt</span><span class="p">,</span>
    <span class="n">build_context</span><span class="p">,</span>
    <span class="n">QueryRetrievePresentationContexts</span><span class="p">,</span>
    <span class="n">StoragePresentationContexts</span><span class="p">,</span>
    <span class="n">VerificationPresentationContexts</span><span class="p">,</span>
    <span class="n">sop_class</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pynetdicom._globals</span> <span class="kn">import</span> <span class="n">ALL_TRANSFER_SYNTAXES</span>
<span class="kn">from</span> <span class="nn">pynetdicom.status</span> <span class="kn">import</span> <span class="n">code_to_category</span>
<span class="kn">from</span> <span class="nn">pynetdicom.sop_class</span> <span class="kn">import</span> <span class="n">StorageServiceClass</span><span class="p">,</span> <span class="n">SOPClass</span><span class="p">,</span> <span class="n">uid_to_sop_class</span>

<span class="c1"># from pynetdicom.pdu_primitives import SOPClassCommonExtendedNegotiation, SOPClassExtendedNegotiation</span>
<span class="kn">from</span> <span class="nn">pynetdicom.transport</span> <span class="kn">import</span> <span class="n">ThreadedAssociationServer</span>
<span class="kn">from</span> <span class="nn">pynetdicom.presentation</span> <span class="kn">import</span> <span class="n">PresentationContext</span>


<span class="kn">from</span> <span class="nn">.info</span> <span class="kn">import</span> <span class="n">VERSION</span>
<span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">InvalidDicomError</span><span class="p">,</span>
    <span class="n">QueryLevel</span><span class="p">,</span>
    <span class="n">QueryResult</span><span class="p">,</span>
    <span class="n">InconsistentDataError</span><span class="p">,</span>
    <span class="n">uid_elems</span><span class="p">,</span>
    <span class="n">req_elems</span><span class="p">,</span>
    <span class="n">opt_elems</span><span class="p">,</span>
    <span class="n">choose_level</span><span class="p">,</span>
    <span class="n">minimal_copy</span><span class="p">,</span>
    <span class="n">get_all_uids</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.report</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseReport</span><span class="p">,</span>
    <span class="n">CountableReport</span><span class="p">,</span>
    <span class="n">MultiListReport</span><span class="p">,</span>
    <span class="n">MultiError</span><span class="p">,</span>
    <span class="n">ProgressHookBase</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">json_serializer</span><span class="p">,</span>
    <span class="n">JsonSerializable</span><span class="p">,</span>
    <span class="n">InlineConfigurable</span><span class="p">,</span>
    <span class="n">create_thread_task</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="n">UID_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;2.25&quot;</span>


<span class="n">IMPLEMENTATION_UID</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.84718903&quot;</span> <span class="o">%</span> <span class="n">UID_PREFIX</span>


<span class="c1"># The DICOM standard only allows an association requestor to propose 128</span>
<span class="c1"># presentation contexts, which is already less than the number of unqiue</span>
<span class="c1"># Storage SOPClasses. We also need to add at least one custom SOPClass (for</span>
<span class="c1"># Siemens non-standard MR data). The &quot;ideal&quot; solution here would be to use</span>
<span class="c1"># extended negotiation to propose more than 128 presentation contexts, but</span>
<span class="c1"># many systems in the wild do not support this. So the &quot;least bad&quot; option for</span>
<span class="c1"># a default is to drop some of the less commonly use SOPClasses. Unfortunately</span>
<span class="c1"># I don&#39;t have objective data on which classes these are, so I have simply</span>
<span class="c1"># choosen ones that seen to be unlikely to come up in my domain.</span>

<span class="n">DEFAULT_DROP_CLASS_REGEXES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Lensometry&quot;</span><span class="p">,</span>
    <span class="s2">&quot;[Rr]efractionMeasurement&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Keratometry&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ophthalmic&quot;</span><span class="p">,</span>
    <span class="s2">&quot;VisualAcuity&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Spectacle&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Intraocular&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Macular&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Corneal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Encapsulated.+Storage&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">DEFAIULT_PRIVATE_SOP_CLASSES</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;SiemensProprietaryMRStorage&quot;</span><span class="p">,</span> <span class="s2">&quot;1.3.12.2.1107.5.9.1&quot;</span><span class="p">),)</span>
<span class="c1"># This is needed so &#39;uid_to_service_class&#39; will work when called for incoming</span>
<span class="c1"># data sets</span>
<span class="k">for</span> <span class="n">cls_name</span><span class="p">,</span> <span class="n">cls_uid</span> <span class="ow">in</span> <span class="n">DEFAIULT_PRIVATE_SOP_CLASSES</span><span class="p">:</span>
    <span class="n">sop_class</span><span class="o">.</span><span class="n">_STORAGE_CLASSES</span><span class="p">[</span><span class="n">cls_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls_uid</span>


<div class="viewcode-block" id="get_filt_sop_classes"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.get_filt_sop_classes">[docs]</a><span class="k">def</span> <span class="nf">get_filt_sop_classes</span><span class="p">(</span>
    <span class="n">include_patterns</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">exclude_patterns</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">private_sop_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_len</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">SOPClass</span><span class="p">]:</span>
    <span class="n">res</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SOPClass</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">private_sop_classes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">priv_uids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">private_sop_classes</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">priv_uids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">private_sop_classes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Duplicate private SOPClass UIDs were passed in&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">priv_uids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">sop_name</span><span class="p">,</span> <span class="n">sop_uid</span> <span class="ow">in</span> <span class="n">sop_class</span><span class="o">.</span><span class="n">_STORAGE_CLASSES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">sop_uid</span> <span class="ow">in</span> <span class="n">priv_uids</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">exclude_patterns</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sop_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">exclude_patterns</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dropping storage class </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sop_name</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">include_patterns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sop_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">include_patterns</span>
        <span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">max_len</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">priv_uids</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Too many storage classes, dropping: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sop_name</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SOPClass</span><span class="p">(</span><span class="n">sop_uid</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">private_sop_classes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sop_name</span><span class="p">,</span> <span class="n">sop_uid</span> <span class="ow">in</span> <span class="n">private_sop_classes</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SOPClass</span><span class="p">(</span><span class="n">sop_uid</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">res</span></div>


<span class="k">def</span> <span class="nf">_make_default_store_scu_pcs</span><span class="p">(</span>
    <span class="n">transfer_syntaxes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PresentationContext</span><span class="p">]:</span>
    <span class="n">include_sops</span> <span class="o">=</span> <span class="n">get_filt_sop_classes</span><span class="p">(</span>
        <span class="n">exclude_patterns</span><span class="o">=</span><span class="n">DEFAULT_DROP_CLASS_REGEXES</span><span class="p">,</span>
        <span class="n">private_sop_classes</span><span class="o">=</span><span class="n">DEFAIULT_PRIVATE_SOP_CLASSES</span><span class="p">,</span>
        <span class="n">max_len</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">build_context</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">transfer_syntaxes</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">include_sops</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_make_default_store_scp_pcs</span><span class="p">(</span>
    <span class="n">transfer_syntaxes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PresentationContext</span><span class="p">]:</span>
    <span class="n">pres_contexts</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">StoragePresentationContexts</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sop_name</span><span class="p">,</span> <span class="n">sop_uid</span> <span class="ow">in</span> <span class="n">DEFAIULT_PRIVATE_SOP_CLASSES</span><span class="p">:</span>
        <span class="n">pres_contexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">build_context</span><span class="p">(</span><span class="n">sop_uid</span><span class="p">,</span> <span class="n">transfer_syntaxes</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pres_contexts</span>


<span class="n">default_store_scu_pcs</span> <span class="o">=</span> <span class="n">_make_default_store_scu_pcs</span><span class="p">()</span>
<span class="n">default_store_scp_pcs</span> <span class="o">=</span> <span class="n">_make_default_store_scp_pcs</span><span class="p">()</span>


<span class="c1"># TODO: We should have an option to use extended negotiation using the below</span>
<span class="c1">#       code as a basis</span>
<span class="c1"># siemens_mr_sop_neg = SOPClassCommonExtendedNegotiation()</span>
<span class="c1"># siemens_mr_sop_neg.sop_class_uid = &#39;1.3.12.2.1107.5.9.1&#39;</span>
<span class="c1"># siemens_mr_sop_neg.service_class_uid = StorageServiceClass.uid</span>
<span class="c1"># siemens_mr_sop_neg.related_general_sop_class_identification = [MRImageStorage]</span>
<span class="c1"># c_store_ext_sop_negs = [siemens_mr_sop_neg]</span>


<span class="c1"># TODO: Need to cosider external limits</span>


<span class="n">QR_MODELS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;PatientRoot&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;find&quot;</span><span class="p">:</span> <span class="n">uid_to_sop_class</span><span class="p">(</span>
            <span class="n">sop_class</span><span class="o">.</span><span class="n">_QR_CLASSES</span><span class="p">[</span><span class="s2">&quot;PatientRootQueryRetrieveInformationModelFind&quot;</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="s2">&quot;move&quot;</span><span class="p">:</span> <span class="n">uid_to_sop_class</span><span class="p">(</span>
            <span class="n">sop_class</span><span class="o">.</span><span class="n">_QR_CLASSES</span><span class="p">[</span><span class="s2">&quot;PatientRootQueryRetrieveInformationModelMove&quot;</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="s2">&quot;get&quot;</span><span class="p">:</span> <span class="n">uid_to_sop_class</span><span class="p">(</span>
            <span class="n">sop_class</span><span class="o">.</span><span class="n">_QR_CLASSES</span><span class="p">[</span><span class="s2">&quot;PatientRootQueryRetrieveInformationModelGet&quot;</span><span class="p">]</span>
        <span class="p">),</span>
    <span class="p">},</span>
    <span class="s2">&quot;StudyRoot&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;find&quot;</span><span class="p">:</span> <span class="n">uid_to_sop_class</span><span class="p">(</span>
            <span class="n">sop_class</span><span class="o">.</span><span class="n">_QR_CLASSES</span><span class="p">[</span><span class="s2">&quot;StudyRootQueryRetrieveInformationModelFind&quot;</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="s2">&quot;move&quot;</span><span class="p">:</span> <span class="n">uid_to_sop_class</span><span class="p">(</span>
            <span class="n">sop_class</span><span class="o">.</span><span class="n">_QR_CLASSES</span><span class="p">[</span><span class="s2">&quot;StudyRootQueryRetrieveInformationModelMove&quot;</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="s2">&quot;get&quot;</span><span class="p">:</span> <span class="n">uid_to_sop_class</span><span class="p">(</span>
            <span class="n">sop_class</span><span class="o">.</span><span class="n">_QR_CLASSES</span><span class="p">[</span><span class="s2">&quot;StudyRootQueryRetrieveInformationModelGet&quot;</span><span class="p">]</span>
        <span class="p">),</span>
    <span class="p">},</span>
    <span class="s2">&quot;PatientStudyOnly&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;find&quot;</span><span class="p">:</span> <span class="n">uid_to_sop_class</span><span class="p">(</span>
            <span class="n">sop_class</span><span class="o">.</span><span class="n">_QR_CLASSES</span><span class="p">[</span><span class="s2">&quot;PatientStudyOnlyQueryRetrieveInformationModelFind&quot;</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="s2">&quot;move&quot;</span><span class="p">:</span> <span class="n">uid_to_sop_class</span><span class="p">(</span>
            <span class="n">sop_class</span><span class="o">.</span><span class="n">_QR_CLASSES</span><span class="p">[</span><span class="s2">&quot;PatientStudyOnlyQueryRetrieveInformationModelMove&quot;</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="s2">&quot;get&quot;</span><span class="p">:</span> <span class="n">uid_to_sop_class</span><span class="p">(</span>
            <span class="n">sop_class</span><span class="o">.</span><span class="n">_QR_CLASSES</span><span class="p">[</span><span class="s2">&quot;PatientStudyOnlyQueryRetrieveInformationModelGet&quot;</span><span class="p">]</span>
        <span class="p">),</span>
    <span class="p">},</span>
<span class="p">}</span>


<div class="viewcode-block" id="DcmNode"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.DcmNode">[docs]</a><span class="nd">@json_serializer</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DcmNode</span><span class="p">(</span><span class="n">JsonSerializable</span><span class="p">,</span> <span class="n">InlineConfigurable</span><span class="p">[</span><span class="s2">&quot;DcmNode&quot;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;DICOM network entity info&quot;&quot;&quot;</span>

    <span class="n">host</span><span class="p">:</span> <span class="nb">str</span>
    <span class="sd">&quot;&quot;&quot;Hostname of the node&quot;&quot;&quot;</span>

    <span class="n">ae_title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ANYAE&quot;</span>
    <span class="sd">&quot;&quot;&quot;DICOM AE Title of the node&quot;&quot;&quot;</span>

    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">11112</span>
    <span class="sd">&quot;&quot;&quot;DICOM port for the node&quot;&quot;&quot;</span>

    <span class="n">qr_models</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;StudyRoot&quot;</span><span class="p">,</span> <span class="s2">&quot;PatientRoot&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Supported DICOM QR models for the node&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae_title</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>

<div class="viewcode-block" id="DcmNode.inline_to_dict"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.DcmNode.inline_to_dict">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">inline_to_dict</span><span class="p">(</span><span class="n">in_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Parse inline string format &#39;host[:ae_title][:port]&#39;</span>

<span class="sd">        Both the second components are optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">toks</span> <span class="o">=</span> <span class="n">in_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Too many tokens for node specification: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">in_str</span><span class="p">)</span>
        <span class="n">res</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ae_title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">toks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s2">&quot;ae_title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span></div></div>


<span class="n">sub_op_attrs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">stat_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="sa">f</span><span class="s2">&quot;NumberOf</span><span class="si">{</span><span class="n">stat_type</span><span class="si">}</span><span class="s2">Suboperations&quot;</span>
    <span class="k">for</span> <span class="n">stat_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Remaining&quot;</span><span class="p">,</span> <span class="s2">&quot;Completed&quot;</span><span class="p">,</span> <span class="s2">&quot;Warning&quot;</span><span class="p">,</span> <span class="s2">&quot;Failed&quot;</span><span class="p">)</span>
<span class="p">}</span>


<div class="viewcode-block" id="BatchDicomOperationError"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.BatchDicomOperationError">[docs]</a><span class="k">class</span> <span class="nc">BatchDicomOperationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for errors from DICOM batch network operations&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BatchDicomOperationError.__init__"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.BatchDicomOperationError.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_errors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]]],</span>
        <span class="n">n_remote_errors</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op_errors</span> <span class="o">=</span> <span class="n">op_errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_remote_errors</span> <span class="o">=</span> <span class="n">n_remote_errors</span></div></div>


<div class="viewcode-block" id="DicomOp"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.DicomOp">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">DicomOp</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Describes a DICOM network operation&quot;&quot;&quot;</span>

    <span class="n">provider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DcmNode</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The service provider&quot;&quot;&quot;</span>

    <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DcmNode</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The service user&quot;&quot;&quot;</span>

    <span class="n">op_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The type of operation performed&quot;&quot;&quot;</span>

    <span class="n">op_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Additional data describing the operation specifics&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DicomOpReport"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.DicomOpReport">[docs]</a><span class="k">class</span> <span class="nc">DicomOpReport</span><span class="p">(</span><span class="n">CountableReport</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Track status results from DICOM operations&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DicomOpReport.__init__"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.DicomOpReport.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">prog_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProgressHookBase</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_expected</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dicom_op</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DicomOp</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dicom_op</span> <span class="o">=</span> <span class="n">DicomOp</span><span class="p">()</span> <span class="k">if</span> <span class="n">dicom_op</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dicom_op</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_success</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remote_warnings</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remote_errors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_sub_ops</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_final_status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">description</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;dicom_op&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dicom_op</span><span class="p">},</span> <span class="n">depth</span><span class="p">,</span> <span class="n">prog_hook</span><span class="p">,</span> <span class="n">n_expected</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_success</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_success</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_errors</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_warnings</span>

<div class="viewcode-block" id="DicomOpReport.add"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.DicomOpReport.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">],</span> <span class="n">data_set</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="s2">&quot;Status&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dicom_op</span><span class="o">.</span><span class="n">op_type</span> <span class="o">==</span> <span class="s2">&quot;c-store&quot;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">data_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">data_set</span> <span class="o">=</span> <span class="n">minimal_copy</span><span class="p">(</span><span class="n">data_set</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">status</span><span class="p">,</span> <span class="n">data_set</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count_input</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">status_category</span> <span class="o">=</span> <span class="n">code_to_category</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">Status</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status_category</span> <span class="o">==</span> <span class="s2">&quot;Pending&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_has_sub_ops</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">sub_op_attrs</span><span class="p">[</span><span class="s2">&quot;remaining&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remaining</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># We don&#39;t have sub-operation counts, so we just count</span>
                <span class="c1"># &#39;pending&#39; results as success</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_n_success</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_success</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">sub_op_attrs</span><span class="p">[</span><span class="s2">&quot;completed&quot;</span><span class="p">])</span>
                <span class="n">n_warn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">sub_op_attrs</span><span class="p">[</span><span class="s2">&quot;warning&quot;</span><span class="p">])</span>
                <span class="n">n_error</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">sub_op_attrs</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_expected</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_expected</span> <span class="o">=</span> <span class="n">remaining</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">n_success</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_success</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_success</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_success</span> <span class="o">&lt;=</span> <span class="n">n_success</span><span class="p">):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DicomOpReport success count mismatch&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_n_success</span> <span class="o">=</span> <span class="n">n_success</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dicom_op</span><span class="o">.</span><span class="n">op_type</span> <span class="o">==</span> <span class="s2">&quot;c-store&quot;</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">data_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="n">data_set</span> <span class="o">=</span> <span class="n">minimal_copy</span><span class="p">(</span><span class="n">data_set</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n_warn</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_warnings</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_warnings</span> <span class="o">&lt;</span> <span class="n">n_warn</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DicomOpReport warning count mismatch&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">status</span><span class="p">,</span> <span class="n">data_set</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">n_error</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_errors</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_errors</span> <span class="o">&lt;</span> <span class="n">n_error</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DicomOpReport error count mismatch&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">status</span><span class="p">,</span> <span class="n">data_set</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_sub_ops</span> <span class="ow">or</span> <span class="n">data_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_final_status</span> <span class="o">=</span> <span class="n">status</span>
                <span class="n">n_success</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">sub_op_attrs</span><span class="p">[</span><span class="s2">&quot;completed&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_success</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">n_warn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">sub_op_attrs</span><span class="p">[</span><span class="s2">&quot;warning&quot;</span><span class="p">])</span>
                    <span class="n">n_error</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">sub_op_attrs</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_success</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_n_success</span> <span class="o">=</span> <span class="n">n_success</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_success</span> <span class="o">&lt;=</span> <span class="n">n_success</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DicomOpReport success count mismatch&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_n_success</span> <span class="o">=</span> <span class="n">n_success</span>
                    <span class="c1"># Some errors/warnings are only reported at the end which we need</span>
                    <span class="c1"># to catch here</span>
                    <span class="k">if</span> <span class="n">n_warn</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DicomOpReport warning count mismatch&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">n_warn</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_remote_warnings</span> <span class="o">=</span> <span class="n">n_warn</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n_error</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;DicomOpReport error count mismatch&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">n_error</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_remote_errors</span> <span class="o">=</span> <span class="n">n_error</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">status_category</span> <span class="o">!=</span> <span class="s2">&quot;Success&quot;</span><span class="p">:</span>
                    <span class="c1"># If we don&#39;t have operation sub-counts, need to make</span>
                    <span class="c1"># sure any final error/warning status doesn&#39;t get lost</span>
                    <span class="k">if</span> <span class="n">status_category</span> <span class="o">==</span> <span class="s2">&quot;Warning&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">status</span><span class="p">,</span> <span class="n">data_set</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">status_category</span> <span class="o">==</span> <span class="s2">&quot;Failure&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">status</span><span class="p">,</span> <span class="n">data_set</span><span class="p">))</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;DicomOpReport (%s &lt;%s&gt; %s) got final status after sub-ops, marking self as done&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dicom_op</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dicom_op</span><span class="o">.</span><span class="n">op_type</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dicom_op</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">status_category</span> <span class="o">==</span> <span class="s2">&quot;Success&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_n_success</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dicom_op</span><span class="o">.</span><span class="n">op_type</span> <span class="o">==</span> <span class="s2">&quot;c-store&quot;</span><span class="p">:</span>
                        <span class="n">data_set</span> <span class="o">=</span> <span class="n">minimal_copy</span><span class="p">(</span><span class="n">data_set</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">status_category</span> <span class="o">==</span> <span class="s2">&quot;Warning&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">status</span><span class="p">,</span> <span class="n">data_set</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">status_category</span> <span class="o">==</span> <span class="s2">&quot;Failure&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">status</span><span class="p">,</span> <span class="n">data_set</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count_input</span><span class="p">()</span></div>

<div class="viewcode-block" id="DicomOpReport.log_issues"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.DicomOpReport.log_issues">[docs]</a>    <span class="k">def</span> <span class="nf">log_issues</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Log a summary of error/warning statuses&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_errors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Got </span><span class="si">%d</span><span class="s2"> error and </span><span class="si">%d</span><span class="s2"> warning statuses out of </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> ops&quot;</span>
                    <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">),</span>
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">),</span>
                        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dicom_op</span><span class="o">.</span><span class="n">op_type</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_errors</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Got </span><span class="si">%d</span><span class="s2"> remote errors, and </span><span class="si">%d</span><span class="s2"> remote warnings&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_remote_errors</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_remote_warnings</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_warnings</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Got </span><span class="si">%d</span><span class="s2"> warning statuses out of </span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> ops&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dicom_op</span><span class="o">.</span><span class="n">op_type</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_warnings</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Got </span><span class="si">%d</span><span class="s2"> remote warnings&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_warnings</span><span class="p">)</span></div>

<div class="viewcode-block" id="DicomOpReport.check_errors"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.DicomOpReport.check_errors">[docs]</a>    <span class="k">def</span> <span class="nf">check_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Raise an exception if any errors occured&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_errors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BatchDicomOperationError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_errors</span><span class="p">)</span></div>

<div class="viewcode-block" id="DicomOpReport.clear"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.DicomOpReport.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clear out all current operation results&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_expected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_expected</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_input</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_success</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remote_warnings</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remote_errors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="nf">_auto_descr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;dicom-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dicom_op</span><span class="o">.</span><span class="n">op_type</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="IncomingErrorType"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.IncomingErrorType">[docs]</a><span class="k">class</span> <span class="nc">IncomingErrorType</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">INCONSISTENT</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">DUPLICATE</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">UNEXPECTED</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>
    <span class="n">INVALID</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span></div>


<div class="viewcode-block" id="IncomingDataError"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.IncomingDataError">[docs]</a><span class="k">class</span> <span class="nc">IncomingDataError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Captures errors detected in incoming data stream&quot;&quot;&quot;</span>

<div class="viewcode-block" id="IncomingDataError.__init__"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.IncomingDataError.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inconsistent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]],</span>
        <span class="n">duplicate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]],</span>
        <span class="n">invalid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]],</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inconsistent</span> <span class="o">=</span> <span class="n">inconsistent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicate</span> <span class="o">=</span> <span class="n">duplicate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span> <span class="o">=</span> <span class="n">invalid</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;IncomingDataError:&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">err_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;inconsistent&quot;</span><span class="p">,</span> <span class="s2">&quot;duplicate&quot;</span><span class="p">,</span> <span class="s2">&quot;invalid&quot;</span><span class="p">):</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">n_errors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_errors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n_errors</span><span class="p">,</span> <span class="n">err_type</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>


<div class="viewcode-block" id="IncomingDataReport"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.IncomingDataReport">[docs]</a><span class="k">class</span> <span class="nc">IncomingDataReport</span><span class="p">(</span><span class="n">CountableReport</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic incoming data report&quot;&quot;&quot;</span>

<div class="viewcode-block" id="IncomingDataReport.__init__"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.IncomingDataReport.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">meta_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">prog_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProgressHookBase</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_expected</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_errors</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">IncomingErrorType</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_errors</span> <span class="o">=</span> <span class="n">keep_errors</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retrieved</span> <span class="o">=</span> <span class="n">QueryResult</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">QueryLevel</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inconsistent</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicate</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">meta_data</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">prog_hook</span><span class="p">,</span> <span class="n">n_expected</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">keep_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">IncomingErrorType</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Whether or not we are forwarding inconsistent/duplicate data&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span>

    <span class="nd">@keep_errors</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">keep_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">IncomingErrorType</span><span class="p">,</span> <span class="o">...</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">IncomingErrorType</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Tuple</span><span class="p">[</span><span class="n">IncomingErrorType</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_success</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retrieved</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">err_type</span> <span class="ow">in</span> <span class="n">IncomingErrorType</span><span class="p">:</span>
            <span class="n">err_attr</span> <span class="o">=</span> <span class="n">err_type</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_attr</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">err_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_attr</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">err_type</span> <span class="ow">in</span> <span class="n">IncomingErrorType</span><span class="p">:</span>
            <span class="n">err_attr</span> <span class="o">=</span> <span class="n">err_type</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_attr</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">err_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_attr</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="IncomingDataReport.add"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.IncomingDataReport.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_set</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add an incoming data set, returns True if it should should be used&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count_input</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dupe</span> <span class="o">=</span> <span class="n">data_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieved</span>
        <span class="k">except</span> <span class="n">InconsistentDataError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inconsistent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_all_uids</span><span class="p">(</span><span class="n">data_set</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">INCONSISTENT</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dupe</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">duplicate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_all_uids</span><span class="p">(</span><span class="n">data_set</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">DUPLICATE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retrieved</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">minimal_copy</span><span class="p">(</span><span class="n">data_set</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">InvalidDicomError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_all_uids</span><span class="p">(</span><span class="n">data_set</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">INVALID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="IncomingDataReport.log_issues"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.IncomingDataReport.log_issues">[docs]</a>    <span class="k">def</span> <span class="nf">log_issues</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Log any warnings and errors&quot;&quot;&quot;</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">warn_msg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">err_type</span> <span class="ow">in</span> <span class="n">IncomingErrorType</span><span class="p">:</span>
            <span class="n">err_attr</span> <span class="o">=</span> <span class="n">err_type</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_attr</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_attr</span><span class="p">)</span>
            <span class="n">n_errors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_errors</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">err_type</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">n_errors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">err_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_errors</span><span class="p">:</span>
                    <span class="n">warn_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">error_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">warn_msg</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Incoming data issues: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">error_msg</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Incoming data issues: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">error_msg</span><span class="p">))</span></div>

<div class="viewcode-block" id="IncomingDataReport.check_errors"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.IncomingDataReport.check_errors">[docs]</a>    <span class="k">def</span> <span class="nf">check_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_errors</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">INCONSISTENT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_errors</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;inconsistent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inconsistent</span>
            <span class="k">if</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">DUPLICATE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_errors</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;duplicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate</span>
            <span class="k">if</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">INVALID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_errors</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;invalid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span>
            <span class="k">raise</span> <span class="n">IncomingDataError</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="IncomingDataReport.clear"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.IncomingDataReport.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inconsistent</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span> <span class="o">=</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">err_type</span> <span class="ow">in</span> <span class="n">IncomingErrorType</span><span class="p">:</span>
            <span class="n">err_attr</span> <span class="o">=</span> <span class="n">err_type</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_attr</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  * </span><span class="si">{</span><span class="n">err_type</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>


<div class="viewcode-block" id="RetrieveError"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.RetrieveError">[docs]</a><span class="k">class</span> <span class="nc">RetrieveError</span><span class="p">(</span><span class="n">IncomingDataError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Capture errors that happened during a retrieve operation&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RetrieveError.__init__"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.RetrieveError.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inconsistent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]],</span>
        <span class="n">duplicate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]],</span>
        <span class="n">invalid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]],</span>
        <span class="n">unexpected</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]],</span>
        <span class="n">missing</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryResult</span><span class="p">],</span>
        <span class="n">move_errors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MultiError</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inconsistent</span> <span class="o">=</span> <span class="n">inconsistent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicate</span> <span class="o">=</span> <span class="n">duplicate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span> <span class="o">=</span> <span class="n">invalid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unexpected</span> <span class="o">=</span> <span class="n">unexpected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing</span> <span class="o">=</span> <span class="n">missing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_errors</span> <span class="o">=</span> <span class="n">move_errors</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RetrieveError:&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">err_type</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;inconsistent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;unexpected&quot;</span><span class="p">,</span>
            <span class="s2">&quot;invalid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;duplicate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;missing&quot;</span><span class="p">,</span>
            <span class="s2">&quot;move_errors&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">MultiError</span><span class="p">):</span>
                <span class="n">n_errors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_errors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_errors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">,&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n_errors</span><span class="p">,</span> <span class="n">err_type</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>


<div class="viewcode-block" id="RetrieveReport"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.RetrieveReport">[docs]</a><span class="k">class</span> <span class="nc">RetrieveReport</span><span class="p">(</span><span class="n">IncomingDataReport</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Track details about a retrieve operation&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RetrieveReport.__init__"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.RetrieveReport.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">meta_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">prog_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProgressHookBase</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_expected</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_errors</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">IncomingErrorType</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">requested</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requested</span> <span class="o">=</span> <span class="n">requested</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unexpected</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_report</span><span class="p">:</span> <span class="n">MultiListReport</span><span class="p">[</span><span class="n">DicomOpReport</span><span class="p">]</span> <span class="o">=</span> <span class="n">MultiListReport</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">description</span><span class="p">,</span> <span class="n">meta_data</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">prog_hook</span><span class="p">,</span> <span class="n">n_expected</span><span class="p">,</span> <span class="n">keep_errors</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">requested</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryResult</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requested</span>

    <span class="nd">@requested</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryResult</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_requested</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requested</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requested</span><span class="o">.</span><span class="n">n_instances</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">n_expected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_expected</span> <span class="o">=</span> <span class="n">n_expected</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">n_errors</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_report</span><span class="o">.</span><span class="n">n_errors</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">UNEXPECTED</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unexpected</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">n_warnings</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_report</span><span class="o">.</span><span class="n">n_warnings</span>
        <span class="k">if</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">UNEXPECTED</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unexpected</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="RetrieveReport.add"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.RetrieveReport.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_set</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count_input</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">data_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested</span>
        <span class="k">except</span> <span class="n">InconsistentDataError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inconsistent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_all_uids</span><span class="p">(</span><span class="n">data_set</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">INCONSISTENT</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">expected</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unexpected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_all_uids</span><span class="p">(</span><span class="n">data_set</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">UNEXPECTED</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span>
        <span class="k">if</span> <span class="n">data_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieved</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duplicate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_all_uids</span><span class="p">(</span><span class="n">data_set</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">DUPLICATE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span>
        <span class="c1"># TODO: Can we avoid duplicate work making min copies here and in the store report?</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retrieved</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">minimal_copy</span><span class="p">(</span><span class="n">data_set</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">InvalidDicomError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_all_uids</span><span class="p">(</span><span class="n">data_set</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">INVALID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="RetrieveReport.log_issues"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.RetrieveReport.log_issues">[docs]</a>    <span class="k">def</span> <span class="nf">log_issues</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Log any warnings and errors&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">log_issues</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_report</span><span class="o">.</span><span class="n">log_issues</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_done</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">n_missing</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_missing</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incoming data issues: </span><span class="si">{</span><span class="n">n_missing</span><span class="si">}</span><span class="s2"> missing&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RetrieveReport.check_errors"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.RetrieveReport.check_errors">[docs]</a>    <span class="k">def</span> <span class="nf">check_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Raise an exception if any errors occured&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_errors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">move_err</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_report</span><span class="o">.</span><span class="n">check_errors</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">MultiError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">move_err</span> <span class="o">=</span> <span class="n">e</span>
            <span class="k">raise</span> <span class="n">RetrieveError</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inconsistent</span>
                <span class="k">if</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">INCONSISTENT</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span>
                <span class="k">else</span> <span class="p">[],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">duplicate</span>
                <span class="k">if</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">DUPLICATE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span>
                <span class="k">else</span> <span class="p">[],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">invalid</span> <span class="k">if</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">INVALID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span> <span class="k">else</span> <span class="p">[],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unexpected</span>
                <span class="k">if</span> <span class="n">IncomingErrorType</span><span class="o">.</span><span class="n">UNEXPECTED</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_errors</span>
                <span class="k">else</span> <span class="p">[],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">missing</span><span class="p">,</span>
                <span class="n">move_err</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="RetrieveReport.clear"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.RetrieveReport.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_report</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unexpected</span> <span class="o">=</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unexpected</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  * unexpected:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unexpected</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  * missing:&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing</span><span class="o">.</span><span class="n">to_tree</span><span class="p">(),</span> <span class="s2">&quot;      &quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_set_done</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_report</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_report</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_report</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n_input</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_report</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_report</span><span class="o">.</span><span class="n">done</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieved</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieved</span></div>


<div class="viewcode-block" id="FailedAssociationError"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.FailedAssociationError">[docs]</a><span class="k">class</span> <span class="nc">FailedAssociationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;We were unable to associate with a remote network node&quot;&quot;&quot;</span></div>


<span class="k">def</span> <span class="nf">_query_worker</span><span class="p">(</span>
    <span class="n">res_q</span><span class="p">:</span> <span class="n">janus</span><span class="o">.</span><span class="n">_SyncQueueProxy</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">QueryResult</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]],</span>
    <span class="n">rep_q</span><span class="p">:</span> <span class="n">janus</span><span class="o">.</span><span class="n">_SyncQueueProxy</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]]]],</span>
    <span class="n">assoc</span><span class="p">:</span> <span class="n">Association</span><span class="p">,</span>
    <span class="n">level</span><span class="p">:</span> <span class="n">QueryLevel</span><span class="p">,</span>
    <span class="n">queries</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Dataset</span><span class="p">],</span>
    <span class="n">query_model</span><span class="p">:</span> <span class="n">sop_class</span><span class="o">.</span><span class="n">SOPClass</span><span class="p">,</span>
    <span class="n">split_level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryLevel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">shutdown</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Worker function for performing queries in a separate thread&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">split_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">PATIENT</span> <span class="ow">or</span> <span class="n">level</span> <span class="o">==</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">STUDY</span><span class="p">:</span>
            <span class="n">split_level</span> <span class="o">=</span> <span class="n">level</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">split_level</span> <span class="o">=</span> <span class="n">QueryLevel</span><span class="p">(</span><span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">split_level</span> <span class="o">&gt;</span> <span class="n">level</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The split_level can&#39;t be higher than the query level&quot;</span><span class="p">)</span>
    <span class="n">split_attr</span> <span class="o">=</span> <span class="n">uid_elems</span><span class="p">[</span><span class="n">split_level</span><span class="p">]</span>
    <span class="n">last_split_val</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">resp_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">q_idx</span><span class="p">,</span> <span class="n">query</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">queries</span><span class="p">):</span>
            <span class="c1"># Before sending another c-find, check if we were asked to shutdown</span>
            <span class="k">if</span> <span class="n">q_idx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">shutdown</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shutdown</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Query worker got shutdown event&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending query:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">QueryResult</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
            <span class="n">missing_attrs</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">status</span><span class="p">,</span> <span class="n">rdat</span> <span class="ow">in</span> <span class="n">assoc</span><span class="o">.</span><span class="n">send_c_find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">query_model</span><span class="o">=</span><span class="n">query_model</span><span class="p">):</span>
                <span class="n">rep_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">status</span><span class="p">,</span> <span class="n">rdat</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">rdat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="c1"># Check periodically if we should shutdown prematurely</span>
                <span class="k">if</span> <span class="n">resp_count</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">shutdown</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shutdown</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Query worker got shutdown event&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="n">resp_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Got query response:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rdat</span><span class="p">)</span>
                <span class="n">split_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rdat</span><span class="p">,</span> <span class="n">split_attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">last_split_val</span> <span class="o">!=</span> <span class="n">split_val</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">res_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">res</span><span class="p">,</span> <span class="n">missing_attrs</span><span class="p">))</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">QueryResult</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
                        <span class="n">missing_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">last_split_val</span> <span class="o">=</span> <span class="n">split_val</span>
                <span class="n">rdat_keys</span> <span class="o">=</span> <span class="n">rdat</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="c1"># TODO: Can&#39;t we just examine the qr at a higher level to determine this?</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rdat_keys</span><span class="p">:</span>
                        <span class="n">keyword</span> <span class="o">=</span> <span class="n">keyword_for_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                        <span class="n">missing_attrs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
                <span class="n">is_consistent</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dupe</span> <span class="o">=</span> <span class="n">rdat</span> <span class="ow">in</span> <span class="n">res</span>
                <span class="k">except</span> <span class="n">InconsistentDataError</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Got inconsistent data in query reponse from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">assoc</span><span class="o">.</span><span class="n">ae</span>
                    <span class="p">)</span>
                    <span class="n">is_consistent</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">dupe</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Got duplicate data in query response from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">assoc</span><span class="o">.</span><span class="n">ae</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">is_consistent</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rdat</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">InvalidDicomError</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Got invalid data in query reponse from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">assoc</span><span class="o">.</span><span class="n">ae</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">res_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">res</span><span class="p">,</span> <span class="n">missing_attrs</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Signal consumers on other end of queues that we are done</span>
        <span class="n">res_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">rep_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_make_move_request</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dataset</span><span class="p">:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">uid_attr</span> <span class="ow">in</span> <span class="n">uid_elems</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">uid_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">uid_attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uid_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">uid_attr</span><span class="p">,</span> <span class="n">uid_val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">_move_worker</span><span class="p">(</span>
    <span class="n">rep_q</span><span class="p">:</span> <span class="n">janus</span><span class="o">.</span><span class="n">_SyncQueueProxy</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]]]],</span>
    <span class="n">assoc</span><span class="p">:</span> <span class="n">Association</span><span class="p">,</span>
    <span class="n">dest</span><span class="p">:</span> <span class="n">DcmNode</span><span class="p">,</span>
    <span class="n">query_res</span><span class="p">:</span> <span class="n">QueryResult</span><span class="p">,</span>
    <span class="n">query_model</span><span class="p">:</span> <span class="n">sop_class</span><span class="o">.</span><span class="n">SOPClass</span><span class="p">,</span>
    <span class="n">shutdown</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Worker function for perfoming move operations in another thread&quot;&quot;&quot;</span>
    <span class="n">in_shutdown</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">d_idx</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">query_res</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">d_idx</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">shutdown</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shutdown</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Move worker exiting from shutdown event&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="n">move_req</span> <span class="o">=</span> <span class="n">_make_move_request</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">move_req</span><span class="o">.</span><span class="n">QueryRetrieveLevel</span> <span class="o">=</span> <span class="n">query_res</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">name</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Worker thread is calling send_c_move&quot;</span><span class="p">)</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="n">assoc</span><span class="o">.</span><span class="n">send_c_move</span><span class="p">(</span><span class="n">move_req</span><span class="p">,</span> <span class="n">dest</span><span class="o">.</span><span class="n">ae_title</span><span class="p">,</span> <span class="n">query_model</span><span class="o">=</span><span class="n">query_model</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Worker is about to iterate responses&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">rdat</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">responses</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Got c-move response&quot;</span><span class="p">)</span>
            <span class="n">rep_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">status</span><span class="p">,</span> <span class="n">rdat</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Queued c-move reponse for report&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r_idx</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shutdown</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shutdown</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Move worker exiting from shutdown event&quot;</span><span class="p">)</span>
                    <span class="n">in_shutdown</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;All responses from c-move have been recieved&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">in_shutdown</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Move worker exiting normally&quot;</span><span class="p">)</span>
    <span class="n">rep_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_send_worker</span><span class="p">(</span>
    <span class="n">send_q</span><span class="p">:</span> <span class="n">janus</span><span class="o">.</span><span class="n">_SyncQueueProxy</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]],</span>
    <span class="n">rep_q</span><span class="p">:</span> <span class="n">janus</span><span class="o">.</span><span class="n">_SyncQueueProxy</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">],</span> <span class="n">Dataset</span><span class="p">]]],</span>
    <span class="n">assoc</span><span class="p">:</span> <span class="n">Association</span><span class="p">,</span>
    <span class="n">shutdown</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Worker function for performing send operations in another thread&quot;&quot;&quot;</span>
    <span class="n">n_sent</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">no_input</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># TODO: Stop ignoring types when this is fixed: https://github.com/aio-libs/janus/issues/267</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">send_q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="n">no_input</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Send worker got None, shutting down...&quot;</span><span class="p">)</span>
                <span class="n">rep_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">no_input</span> <span class="ow">or</span> <span class="n">n_sent</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">shutdown</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shutdown</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">no_input</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Send worker got a data set&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">assoc</span><span class="o">.</span><span class="n">send_c_store</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">rep_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">e</span><span class="p">,</span> <span class="n">ds</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rep_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">status</span><span class="p">,</span> <span class="n">ds</span><span class="p">))</span>


<div class="viewcode-block" id="UnsupportedQueryModelError"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.UnsupportedQueryModelError">[docs]</a><span class="k">class</span> <span class="nc">UnsupportedQueryModelError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The requested query model isn&#39;t supported by the remote entity&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="EventFilter"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.EventFilter">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">EventFilter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Define a filter that matches a subset of pynetdicom events&quot;&quot;&quot;</span>

    <span class="n">event_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenSet</span><span class="p">[</span><span class="n">evt</span><span class="o">.</span><span class="n">InterventionEvent</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Set of event types we want to match&quot;&quot;&quot;</span>

    <span class="n">ae_titles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FrozenSet</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Set of AE Titles we want to match&quot;&quot;&quot;</span>

<div class="viewcode-block" id="EventFilter.matches"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.EventFilter.matches">[docs]</a>    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">evt</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Test if the `event` matches the filter&quot;&quot;&quot;</span>
        <span class="c1"># TODO: The _event attr is made public as &#39;evt&#39; in future pynetdicom</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">_event</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_types</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae_titles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">norm_ae</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">assoc</span><span class="o">.</span><span class="n">requestor</span><span class="o">.</span><span class="n">ae_title</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">norm_ae</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae_titles</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="EventFilter.collides"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.EventFilter.collides">[docs]</a>    <span class="k">def</span> <span class="nf">collides</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">EventFilter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Test if this filter collides with the `other` filter&quot;&quot;&quot;</span>
        <span class="n">evt_collision</span> <span class="o">=</span> <span class="n">remote_collision</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_types</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">event_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">evt_collision</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_types</span> <span class="o">&amp;</span> <span class="n">other</span><span class="o">.</span><span class="n">event_types</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">evt_collision</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae_titles</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">ae_titles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">remote_collision</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ae_titles</span> <span class="o">&amp;</span> <span class="n">other</span><span class="o">.</span><span class="n">ae_titles</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">remote_collision</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">evt_collision</span> <span class="ow">and</span> <span class="n">remote_collision</span></div></div>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="n">_FutureType</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">_FutureType</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span>


<div class="viewcode-block" id="FilteredListenerLockBase"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.FilteredListenerLockBase">[docs]</a><span class="k">class</span> <span class="nc">FilteredListenerLockBase</span><span class="p">(</span><span class="n">_FutureType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for creating event filter aware lock types with fifolock&quot;&quot;&quot;</span>

    <span class="n">event_filter</span><span class="p">:</span> <span class="n">EventFilter</span>

<div class="viewcode-block" id="FilteredListenerLockBase.is_compatible"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.FilteredListenerLockBase.is_compatible">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_compatible</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">holds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">FilteredListenerLockBase</span><span class="p">],</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">lock_type</span><span class="p">,</span> <span class="n">n_holds</span> <span class="ow">in</span> <span class="n">holds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">n_holds</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">cls</span><span class="o">.</span><span class="n">event_filter</span><span class="o">.</span><span class="n">collides</span><span class="p">(</span><span class="n">lock_type</span><span class="o">.</span><span class="n">event_filter</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div></div>


<span class="n">default_evt_pc_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">evt</span><span class="o">.</span><span class="n">EVT_C_ECHO</span><span class="p">:</span> <span class="n">VerificationPresentationContexts</span><span class="p">,</span>
    <span class="n">evt</span><span class="o">.</span><span class="n">EVT_C_STORE</span><span class="p">:</span> <span class="n">default_store_scp_pcs</span><span class="p">,</span>
    <span class="n">evt</span><span class="o">.</span><span class="n">EVT_C_FIND</span><span class="p">:</span> <span class="n">QueryRetrievePresentationContexts</span><span class="p">,</span>
<span class="p">}</span>
<span class="sd">&quot;&quot;&quot;Map event types to the default presentation contexts the AE needs to accept</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="make_sync_to_async_cb"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.make_sync_to_async_cb">[docs]</a><span class="k">def</span> <span class="nf">make_sync_to_async_cb</span><span class="p">(</span>
    <span class="n">async_cb</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">evt</span><span class="o">.</span><span class="n">Event</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">loop</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">evt</span><span class="o">.</span><span class="n">Event</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Return sync callback that bridges to an async callback&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">sync_cb</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">evt</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># Calling get_event_loop from sync code can return the wrong loop</span>
        <span class="c1"># sometimes, in which case the below code hangs without error.</span>
        <span class="c1"># This assertion should catch that issue.</span>
        <span class="k">assert</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">async_cb</span><span class="p">(</span><span class="n">event</span><span class="p">),</span> <span class="n">loop</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">return</span> <span class="n">sync_cb</span></div>


<div class="viewcode-block" id="make_queue_data_cb"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.make_queue_data_cb">[docs]</a><span class="k">def</span> <span class="nf">make_queue_data_cb</span><span class="p">(</span>
    <span class="n">res_q</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">FileMetaDataset</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">evt</span><span class="o">.</span><span class="n">Event</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Return callback that queues dataset/metadata from incoming events&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">evt</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">res_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">event</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">file_meta</span><span class="p">))</span>
        <span class="k">return</span> <span class="mh">0x0</span>  <span class="c1"># Success</span>

    <span class="k">return</span> <span class="n">callback</span></div>


<div class="viewcode-block" id="is_specified"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.is_specified">[docs]</a><span class="k">def</span> <span class="nf">is_specified</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="s2">&quot;*&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<span class="n">SOPList</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">sop_class</span><span class="o">.</span><span class="n">SOPClass</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">_SingletonEntity</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make sure we have a single LocalEntity for each ae_title/port combo&quot;&quot;&quot;</span>

    <span class="n">_instances</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: ignore</span>
    <span class="n">_init</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_SingletonEntity</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_init</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="n">init</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_init</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
        <span class="n">local_node</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getcallargs</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="s2">&quot;local&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">local_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;local&#39; arg can&#39;t be None&quot;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">local_node</span><span class="o">.</span><span class="n">ae_title</span><span class="p">,</span> <span class="n">local_node</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">_SingletonEntity</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


<span class="c1"># TODO: Need to set max threads based on number of sources, or somehow be smarter</span>
<span class="c1">#       about it as it is a potential source of deadlocks if too low</span>
<span class="c1"># TODO: Need to listen for association aborted events and handle them</span>
<div class="viewcode-block" id="LocalEntity"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.LocalEntity">[docs]</a><span class="k">class</span> <span class="nc">LocalEntity</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">_SingletonEntity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Low level interface to DICOM networking functionality</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    local</span>
<span class="sd">        The local DICOM network node properties</span>

<span class="sd">    transfer_syntaxes</span>
<span class="sd">        The transfer syntaxes to use for any data transfers</span>

<span class="sd">    max_threads</span>
<span class="sd">        Size of thread pool</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LocalEntity.__init__"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.LocalEntity.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">local</span><span class="p">:</span> <span class="n">DcmNode</span><span class="p">,</span>
        <span class="n">transfer_syntaxes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SOPList</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local</span> <span class="o">=</span> <span class="n">local</span>
        <span class="k">if</span> <span class="n">transfer_syntaxes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default_ts</span> <span class="o">=</span> <span class="p">[</span><span class="n">uid_to_sop_class</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ALL_TRANSFER_SYNTAXES</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default_ts</span> <span class="o">=</span> <span class="n">transfer_syntaxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ae</span> <span class="o">=</span> <span class="n">AE</span><span class="p">(</span><span class="n">ae_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">ae_title</span><span class="p">)</span>
        <span class="c1"># Certain operations can be slow to start up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ae</span><span class="o">.</span><span class="n">dimse_timeout</span> <span class="o">=</span> <span class="mi">180</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_threads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listener_lock</span> <span class="o">=</span> <span class="n">FifoLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock_types</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EventFilter</span><span class="p">,</span> <span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_handlers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
            <span class="n">EventFilter</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">evt</span><span class="o">.</span><span class="n">Event</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listen_mgr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ThreadedAssociationServer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">local</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DcmNode</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;DcmNode for our local entity&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span>

<div class="viewcode-block" id="LocalEntity.echo"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.LocalEntity.echo">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote</span><span class="p">:</span> <span class="n">DcmNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perfrom an &quot;echo&quot; against `remote` to test connectivity</span>

<span class="sd">        Returns True if successful, else False. Throws FailedAssociationError if the</span>
<span class="sd">        initial association with the `remote` fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_associate</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">VerificationPresentationContexts</span><span class="p">)</span> <span class="k">as</span> <span class="n">assoc</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="p">,</span> <span class="n">assoc</span><span class="o">.</span><span class="n">send_c_echo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">and</span> <span class="n">status</span><span class="o">.</span><span class="n">Status</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="LocalEntity.query"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.LocalEntity.query">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">remote</span><span class="p">:</span> <span class="n">DcmNode</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryLevel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">query_res</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">report</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MultiListReport</span><span class="p">[</span><span class="n">DicomOpReport</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QueryResult</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Query the `remote` entity all at once</span>

<span class="sd">        See documentation for the `queries` method for details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">level</span><span class="p">,</span> <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_query</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">query_res</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">QueryResult</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">sub_res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">query_res</span><span class="p">,</span> <span class="n">report</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">|=</span> <span class="n">sub_res</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="LocalEntity.queries"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.LocalEntity.queries">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">queries</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">remote</span><span class="p">:</span> <span class="n">DcmNode</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryLevel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">query_res</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryResult</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">report</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MultiListReport</span><span class="p">[</span><span class="n">DicomOpReport</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">QueryResult</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Query the `remote` entity in an iterative manner</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remote</span>
<span class="sd">            The network node we are querying</span>

<span class="sd">        level</span>
<span class="sd">            The level of detail we want to query</span>

<span class="sd">            If not provided, we try to automatically determine the most appropriate</span>
<span class="sd">            level based on the `query`, then the `query_res`, and finally fall back to</span>
<span class="sd">            using `QueryLevel.STUDY`.</span>

<span class="sd">        query</span>
<span class="sd">            Specifies the DICOM attributes we want to query with/for</span>

<span class="sd">        query_res</span>
<span class="sd">            A query result that we want to refine</span>

<span class="sd">        report</span>
<span class="sd">            If provided, will store status report from DICOM operations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">report</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extern_report</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">MultiListReport</span><span class="p">(</span><span class="n">meta_data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;remote&quot;</span><span class="p">:</span> <span class="n">remote</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="n">level</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extern_report</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">_description</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;queries&quot;</span>
        <span class="n">report</span><span class="o">.</span><span class="n">_meta_data</span><span class="p">[</span><span class="s2">&quot;remote&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remote</span>

        <span class="n">level</span><span class="p">,</span> <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_query</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">query_res</span><span class="p">)</span>

        <span class="n">report</span><span class="o">.</span><span class="n">_meta_data</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span>
        <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">_meta_data</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span>
        <span class="k">if</span> <span class="n">query_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_qr_meta</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">query_res</span><span class="p">)</span>

        <span class="c1"># Determine the query model</span>
        <span class="n">query_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_qr_model</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="s2">&quot;find&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="c1"># If we are missing some required higher-level identifiers, we perform</span>
        <span class="c1"># a recursive pre-query to get those first</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">level</span> <span class="o">==</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">STUDY</span>
            <span class="ow">and</span> <span class="n">query_model</span> <span class="o">==</span> <span class="n">QR_MODELS</span><span class="p">[</span><span class="s2">&quot;PatientRoot&quot;</span><span class="p">][</span><span class="s2">&quot;find&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_specified</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;PatientID&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">query_res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Performing recursive PATIENT level query against </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">remote</span><span class="p">,)</span>
                <span class="p">)</span>
                <span class="n">query_res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="n">remote</span><span class="p">,</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">PATIENT</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">query_res</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">SERIES</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_specified</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;StudyInstanceUID&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">query_res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">query_res</span><span class="o">.</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">STUDY</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Performing recursive STUDY level query against </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">remote</span><span class="p">,)</span>
                <span class="p">)</span>
                <span class="n">query_res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">STUDY</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">query_res</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">IMAGE</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_specified</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s2">&quot;SeriesInstanceUID&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">query_res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">query_res</span><span class="o">.</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">SERIES</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Performing recursive SERIES level query against </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">remote</span><span class="p">,)</span>
                <span class="p">)</span>
                <span class="n">query_res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="n">remote</span><span class="p">,</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">SERIES</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">query_res</span>
                <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Performing </span><span class="si">%s</span><span class="s2"> level query against </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">remote</span><span class="p">))</span>

        <span class="c1"># Add in any required and default optional elements to query</span>
        <span class="k">for</span> <span class="n">lvl</span> <span class="ow">in</span> <span class="n">QueryLevel</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">req_attr</span> <span class="ow">in</span> <span class="n">req_elems</span><span class="p">[</span><span class="n">lvl</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">req_attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">req_attr</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lvl</span> <span class="o">==</span> <span class="n">level</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">auto_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">opt_attr</span> <span class="ow">in</span> <span class="n">opt_elems</span><span class="p">[</span><span class="n">level</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">opt_attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">opt_attr</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">auto_attrs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opt_attr</span><span class="p">)</span>

        <span class="c1"># Set the QueryRetrieveLevel</span>
        <span class="n">query</span><span class="o">.</span><span class="n">QueryRetrieveLevel</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Pull out a list of the attributes we are querying on</span>
        <span class="n">queried_elems</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">keyword</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">query</span><span class="p">)</span>

        <span class="c1"># If QueryResult was given we potentially generate multiple</span>
        <span class="c1"># queries, one for each dataset referenced by the QueryResult</span>
        <span class="k">if</span> <span class="n">query_res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">queries</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">sub_uids</span> <span class="ow">in</span> <span class="n">query_res</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">query_res</span><span class="o">.</span><span class="n">level</span><span class="p">):</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">lvl</span> <span class="ow">in</span> <span class="n">QueryLevel</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">lvl</span> <span class="o">&gt;</span> <span class="n">path</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">uid_elems</span><span class="p">[</span><span class="n">lvl</span><span class="p">],</span> <span class="n">path</span><span class="o">.</span><span class="n">uids</span><span class="p">[</span><span class="n">lvl</span><span class="p">])</span>
                        <span class="n">queried_elems</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">uid_elems</span><span class="p">[</span><span class="n">lvl</span><span class="p">])</span>
                    <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                    <span class="n">sub_uids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;QueryResult expansion results in </span><span class="si">%d</span><span class="s2"> sub-queries&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">n_expected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>

        <span class="c1"># Build a queue for results from query thread</span>
        <span class="n">res_q</span><span class="p">:</span> <span class="n">janus</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">QueryResult</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">janus</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="n">rep_q</span><span class="p">:</span> <span class="n">janus</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">janus</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

        <span class="c1"># Make shutdown event for query worker</span>
        <span class="n">query_shutdown</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># Setup args for building reports</span>
        <span class="n">dicom_op</span> <span class="o">=</span> <span class="n">DicomOp</span><span class="p">(</span><span class="n">provider</span><span class="o">=</span><span class="n">remote</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="p">,</span> <span class="n">op_type</span><span class="o">=</span><span class="s2">&quot;c-find&quot;</span><span class="p">)</span>
        <span class="n">op_report_attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dicom_op&quot;</span><span class="p">:</span> <span class="n">dicom_op</span><span class="p">,</span>
            <span class="s2">&quot;prog_hook&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">_prog_hook</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Create association with the remote node</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Making association with </span><span class="si">%s</span><span class="s2"> for query&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">remote</span><span class="p">,))</span>
        <span class="c1"># While we will signal the worker thread to shutdown before sending any C-CANCEL</span>
        <span class="c1"># there is no gaurantee the worker will see it, so we send the C-CANCEL and</span>
        <span class="c1"># close the association before waiting for the thread to finish</span>
        <span class="n">query_fut</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">rep_builder_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_associate</span><span class="p">(</span>
                <span class="n">remote</span><span class="p">,</span> <span class="n">QueryRetrievePresentationContexts</span><span class="p">,</span> <span class="n">query_model</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">assoc</span><span class="p">:</span>
                <span class="c1"># Fire up a thread to perform the query and produce QueryResult chunks</span>
                <span class="n">rep_builder_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_multi_report_builder</span><span class="p">(</span><span class="n">rep_q</span><span class="o">.</span><span class="n">async_q</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">op_report_attrs</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">query_fut</span> <span class="o">=</span> <span class="n">create_thread_task</span><span class="p">(</span>
                    <span class="n">_query_worker</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">res_q</span><span class="o">.</span><span class="n">sync_q</span><span class="p">,</span> <span class="n">rep_q</span><span class="o">.</span><span class="n">sync_q</span><span class="p">,</span> <span class="n">assoc</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">queries</span><span class="p">,</span> <span class="n">query_model</span><span class="p">),</span>
                    <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">,</span>
                    <span class="n">thread_pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="p">,</span>
                    <span class="n">shutdown</span><span class="o">=</span><span class="n">query_shutdown</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">qr_fut_done</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">qr_fut_exception</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                                <span class="n">res_q</span><span class="o">.</span><span class="n">async_q</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">qr_fut_exception</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">qr_fut_exception</span>
                            <span class="k">assert</span> <span class="n">qr_fut_done</span> <span class="o">==</span> <span class="kc">False</span>
                            <span class="c1"># Check if the worker thread is done</span>
                            <span class="k">if</span> <span class="n">query_fut</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                                <span class="n">qr_fut_done</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">qr_fut_exception</span> <span class="o">=</span> <span class="n">query_fut</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="n">qr</span><span class="p">,</span> <span class="n">missing_attrs</span> <span class="o">=</span> <span class="n">res</span>
                            <span class="k">for</span> <span class="n">missing_attr</span> <span class="ow">in</span> <span class="n">missing_attrs</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">missing_attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">auto_attrs</span><span class="p">:</span>
                                    <span class="c1"># TODO: Still getting some false positives with this</span>
                                    <span class="c1">#       warning, presumably from pre-queries. Disable</span>
                                    <span class="c1">#       it until it is more reliable.</span>
                                    <span class="k">pass</span>
                                    <span class="c1"># warnings.warn(f&quot;Remote node {remote} doesn&#39;t &quot;</span>
                                    <span class="c1">#              f&quot;support querying on {missing_attr}&quot;)</span>
                            <span class="n">qr</span><span class="o">.</span><span class="n">prov</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">remote</span>
                            <span class="n">qr</span><span class="o">.</span><span class="n">prov</span><span class="o">.</span><span class="n">queried_elems</span> <span class="o">=</span> <span class="n">queried_elems</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="k">yield</span> <span class="n">qr</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting shutdown event for query worker&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="p">,</span> <span class="n">query_shutdown</span><span class="o">.</span><span class="n">set</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">query_fut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for query worker thread to finish&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">query_fut</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;The query worker thread has closed&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for query report builder task to finish&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rep_builder_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">rep_builder_task</span>
                <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception from report builder task&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">extern_report</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">log_issues</span><span class="p">()</span>
            <span class="n">report</span><span class="o">.</span><span class="n">check_errors</span><span class="p">()</span></div>

<div class="viewcode-block" id="LocalEntity.listen"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.LocalEntity.listen">[docs]</a>    <span class="nd">@asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">listen</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">evt</span><span class="o">.</span><span class="n">Event</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="n">event_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EventFilter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">presentation_contexts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">PresentationContext</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Listen for incoming DICOM network events</span>

<span class="sd">        The async callback `handler` will be called for each DICOM network</span>
<span class="sd">        event that matches the `event_filter`. The default filter matches all</span>
<span class="sd">        events.</span>

<span class="sd">        Locks are used internally to prevent two listeners with colliding event</span>
<span class="sd">        filters from running simultaneously. Avoiding deadlocks due to</span>
<span class="sd">        dependency loops must be handled at a higher level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">event_filter</span> <span class="o">=</span> <span class="n">EventFilter</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">presentation_contexts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Building list of default presentation contexts&quot;</span><span class="p">)</span>
            <span class="n">presentation_contexts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">event_filter</span><span class="o">.</span><span class="n">event_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p_contexts</span> <span class="ow">in</span> <span class="n">default_evt_pc_map</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">presentation_contexts</span> <span class="o">+=</span> <span class="n">p_contexts</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">event_type</span> <span class="ow">in</span> <span class="n">event_filter</span><span class="o">.</span><span class="n">event_types</span><span class="p">:</span>
                    <span class="n">presentation_contexts</span> <span class="o">+=</span> <span class="n">default_evt_pc_map</span><span class="p">[</span><span class="n">event_type</span><span class="p">]</span>
        <span class="n">LockType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lock_type</span><span class="p">(</span><span class="n">event_filter</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;About to wait on listener lock&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listener_lock</span><span class="p">(</span><span class="n">LockType</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Listener lock acquired&quot;</span><span class="p">)</span>
            <span class="c1"># If we don&#39;t already have a threaded listener running, set it up</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listen_mgr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sync_cb</span> <span class="o">=</span> <span class="n">make_sync_to_async_cb</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fwd_event</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_setup_listen_mgr</span><span class="p">(</span><span class="n">sync_cb</span><span class="p">,</span> <span class="n">presentation_contexts</span><span class="p">)</span>
            <span class="c1"># Some sanity checks that our locking scheme is working</span>
            <span class="k">assert</span> <span class="n">event_filter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_handlers</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">event_filter</span><span class="o">.</span><span class="n">collides</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_handlers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_event_handlers</span><span class="p">[</span><span class="n">event_filter</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_handlers</span><span class="p">[</span><span class="n">event_filter</span><span class="p">]</span>
                <span class="c1"># If no one else is listening, or waiting to listen, clean up</span>
                <span class="c1"># the threaded listener</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_listener_lock</span><span class="o">.</span><span class="n">_waiters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_listener_lock</span><span class="o">.</span><span class="n">_holds</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="p">):</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_listen_mgr</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Listener lock released&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LocalEntity.move"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.LocalEntity.move">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">move</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">DcmNode</span><span class="p">,</span>
        <span class="n">dest</span><span class="p">:</span> <span class="n">DcmNode</span><span class="p">,</span>
        <span class="n">query_res</span><span class="p">:</span> <span class="n">QueryResult</span><span class="p">,</span>
        <span class="n">transfer_syntax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SOPList</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">report</span><span class="p">:</span> <span class="n">MultiListReport</span><span class="p">[</span><span class="n">DicomOpReport</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Move DICOM files from one network entity to another&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">report</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extern_report</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">MultiListReport</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extern_report</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">_description</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;move&quot;</span>
        <span class="n">report</span><span class="o">.</span><span class="n">_meta_data</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span>
        <span class="n">report</span><span class="o">.</span><span class="n">_meta_data</span><span class="p">[</span><span class="s2">&quot;dest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_qr_meta</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">query_res</span><span class="p">)</span>
        <span class="n">query_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_qr_model</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="n">query_res</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">transfer_syntax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transfer_syntax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_ts</span>
        <span class="c1"># Setup queue args for building reports</span>
        <span class="n">rep_q</span><span class="p">:</span> <span class="n">janus</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">janus</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="n">dicom_op</span> <span class="o">=</span> <span class="n">DicomOp</span><span class="p">(</span><span class="n">provider</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="p">,</span> <span class="n">op_type</span><span class="o">=</span><span class="s2">&quot;c-move&quot;</span><span class="p">)</span>
        <span class="n">op_report_attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dicom_op&quot;</span><span class="p">:</span> <span class="n">dicom_op</span><span class="p">,</span>
            <span class="s2">&quot;prog_hook&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">_prog_hook</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Make shutdown event for worker</span>
        <span class="n">move_shutdown</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="c1"># Setup the association</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;About to associate with </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> to move data&quot;</span><span class="p">)</span>
        <span class="n">worker_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">rep_builder_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_associate</span><span class="p">(</span>
                <span class="n">source</span><span class="p">,</span> <span class="n">QueryRetrievePresentationContexts</span><span class="p">,</span> <span class="n">query_model</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">assoc</span><span class="p">:</span>
                <span class="n">rep_builder_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_multi_report_builder</span><span class="p">(</span><span class="n">rep_q</span><span class="o">.</span><span class="n">async_q</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">op_report_attrs</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">worker_task</span> <span class="o">=</span> <span class="n">create_thread_task</span><span class="p">(</span>
                        <span class="n">_move_worker</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">rep_q</span><span class="o">.</span><span class="n">sync_q</span><span class="p">,</span> <span class="n">assoc</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">query_res</span><span class="p">,</span> <span class="n">query_model</span><span class="p">),</span>
                        <span class="n">thread_pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="p">,</span>
                        <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">,</span>
                        <span class="n">shutdown</span><span class="o">=</span><span class="n">move_shutdown</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="n">worker_task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting shutdown event for move worker&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="p">,</span> <span class="n">move_shutdown</span><span class="o">.</span><span class="n">set</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># No matter what we set the shutdown event for the worker thread above,</span>
            <span class="c1"># so nothing to do here but prevent any CancelledError from propogating</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for move worker task thread to finish&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">worker_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">worker_task</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Move worker task has finished&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rep_builder_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">rep_builder_task</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Report builder task is done&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">extern_report</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">log_issues</span><span class="p">()</span>
            <span class="n">report</span><span class="o">.</span><span class="n">check_errors</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Call to LocalEntity.move has completed&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LocalEntity.retrieve"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.LocalEntity.retrieve">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">remote</span><span class="p">:</span> <span class="n">DcmNode</span><span class="p">,</span>
        <span class="n">query_res</span><span class="p">:</span> <span class="n">QueryResult</span><span class="p">,</span>
        <span class="n">report</span><span class="p">:</span> <span class="n">RetrieveReport</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_errors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">IncomingErrorType</span><span class="p">,</span> <span class="o">...</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Generate data sets from `remote` based on `query_res`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remote</span>
<span class="sd">            The remote DICOM network node we want to get data from</span>

<span class="sd">        query_res</span>
<span class="sd">            The data we want to retrieve</span>

<span class="sd">        report</span>
<span class="sd">            If provided this will be populated asynchronously</span>

<span class="sd">        keep_errors</span>
<span class="sd">            Generate data sets even if we detect issues with them</span>

<span class="sd">            By default inconsistent, unexpected, and duplicate data are skipped</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">report</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extern_report</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">RetrieveReport</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extern_report</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">report</span><span class="o">.</span><span class="n">requested</span> <span class="o">=</span> <span class="n">query_res</span>
        <span class="n">report</span><span class="o">.</span><span class="n">_meta_data</span><span class="p">[</span><span class="s2">&quot;remote&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remote</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_qr_meta</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">query_res</span><span class="p">)</span>

        <span class="c1"># TODO: Stop ignoring type errors here once mypy fixes issue #3004</span>
        <span class="k">if</span> <span class="n">keep_errors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">keep_errors</span> <span class="o">=</span> <span class="n">keep_errors</span>  <span class="c1"># type: ignore</span>
        <span class="n">event_filter</span> <span class="o">=</span> <span class="n">EventFilter</span><span class="p">(</span>
            <span class="n">event_types</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">((</span><span class="n">evt</span><span class="o">.</span><span class="n">EVT_C_STORE</span><span class="p">,)),</span>
            <span class="n">ae_titles</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">((</span><span class="n">remote</span><span class="o">.</span><span class="n">ae_title</span><span class="p">,)),</span>
        <span class="p">)</span>
        <span class="n">res_q</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">FileMetaDataset</span><span class="p">]]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">retrieve_cb</span> <span class="o">=</span> <span class="n">make_queue_data_cb</span><span class="p">(</span><span class="n">res_q</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;The &#39;retrieve&#39; method is about to start listening&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">retrieve_cb</span><span class="p">,</span> <span class="n">event_filter</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;The &#39;retrieve&#39; method is about to fire up a move task&quot;</span><span class="p">)</span>
            <span class="n">move_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="p">,</span> <span class="n">query_res</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">move_report</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ds</span><span class="p">,</span> <span class="n">file_meta</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">res_q</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                        <span class="c1"># Check if the move task is done</span>
                        <span class="k">if</span> <span class="n">move_task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="c1"># Add the data set to our report and handle errors</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retrieved data set filtered due to error&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="c1"># Remove any Group 0x0002 elements that may have been included</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="mh">0x00030000</span><span class="p">:]</span>
                    <span class="c1"># Add the file_meta to the data set and yield it</span>
                    <span class="c1"># TODO: Get implementation UID and set it here</span>
                    <span class="c1"># file_meta.ImplementationUID = ...</span>
                    <span class="c1"># file_meta.ImplementationVersionName = VERSION</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">file_meta</span> <span class="o">=</span> <span class="n">file_meta</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">is_little_endian</span> <span class="o">=</span> <span class="n">file_meta</span><span class="o">.</span><span class="n">TransferSyntaxUID</span><span class="o">.</span><span class="n">is_little_endian</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">is_implicit_VR</span> <span class="o">=</span> <span class="n">file_meta</span><span class="o">.</span><span class="n">TransferSyntaxUID</span><span class="o">.</span><span class="n">is_implicit_VR</span>
                    <span class="k">yield</span> <span class="n">ds</span>
            <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retrieve generator closed early, cancelling move&quot;</span><span class="p">)</span>
                <span class="n">move_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Waiting for move task to finish&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">move_task</span>
        <span class="n">report</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">extern_report</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">log_issues</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;About to check errors&quot;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">check_errors</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;The LocalEntity.retrieve method has completed&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LocalEntity.send"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.LocalEntity.send">[docs]</a>    <span class="nd">@asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">remote</span><span class="p">:</span> <span class="n">DcmNode</span><span class="p">,</span>
        <span class="n">transfer_syntax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SOPList</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">report</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DicomOpReport</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">janus</span><span class="o">.</span><span class="n">_AsyncQueueProxy</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Produces a queue where you can put data sets to be sent to `remote`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        remote</span>
<span class="sd">            The remote node we are sending the data to</span>

<span class="sd">        transfer_syntax</span>
<span class="sd">            The DICOM transfer syntax to use for the transfer</span>

<span class="sd">        report</span>
<span class="sd">            If provided, the results of the send operations will be put here</span>

<span class="sd">            This report will be updated throughout the transfer and can be</span>
<span class="sd">            examined within the context manager for partial results. The report</span>
<span class="sd">            will not always be up-to-date with the most recent datasets put</span>
<span class="sd">            into the queue (until the context manager is closed).</span>

<span class="sd">            If this is provided, the normal warning/error behavior is skipped</span>
<span class="sd">            as it is assumed the caller will handle this themselves (e.g. by</span>
<span class="sd">            calling the `log_issues` and `check_errors` methods on the report).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">transfer_syntax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transfer_syntax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_ts</span>
        <span class="k">if</span> <span class="n">report</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extern_report</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">DicomOpReport</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extern_report</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">report</span><span class="o">.</span><span class="n">dicom_op</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">remote</span>
        <span class="n">report</span><span class="o">.</span><span class="n">dicom_op</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span>
        <span class="n">report</span><span class="o">.</span><span class="n">dicom_op</span><span class="o">.</span><span class="n">op_type</span> <span class="o">=</span> <span class="s2">&quot;c-store&quot;</span>
        <span class="n">send_q</span><span class="p">:</span> <span class="n">janus</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]]</span> <span class="o">=</span> <span class="n">janus</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">rep_q</span><span class="p">:</span> <span class="n">janus</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">janus</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;About to associate with </span><span class="si">{</span><span class="n">remote</span><span class="si">}</span><span class="s2"> to send data&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_associate</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">default_store_scu_pcs</span><span class="p">)</span> <span class="k">as</span> <span class="n">assoc</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rep_builder_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_single_report_builder</span><span class="p">(</span><span class="n">rep_q</span><span class="o">.</span><span class="n">async_q</span><span class="p">,</span> <span class="n">report</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">send_fut</span> <span class="o">=</span> <span class="n">create_thread_task</span><span class="p">(</span>
                    <span class="n">_send_worker</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">send_q</span><span class="o">.</span><span class="n">sync_q</span><span class="p">,</span> <span class="n">rep_q</span><span class="o">.</span><span class="n">sync_q</span><span class="p">,</span> <span class="n">assoc</span><span class="p">),</span>
                    <span class="n">thread_pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Want it to be an error if external user sends None, so we have type</span>
                <span class="c1"># mis-match here</span>
                <span class="k">yield</span> <span class="n">send_q</span><span class="o">.</span><span class="n">async_q</span>  <span class="c1"># type: ignore</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Signal send worker to shutdown, then wait for it</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Shutting down send worker&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">send_q</span><span class="o">.</span><span class="n">async_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">send_fut</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Send worker has shutdown, waiting for report builder&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">rep_builder_task</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">report</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">extern_report</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">log_issues</span><span class="p">()</span>
            <span class="n">report</span><span class="o">.</span><span class="n">check_errors</span><span class="p">()</span></div>

<div class="viewcode-block" id="LocalEntity.download"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.LocalEntity.download">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">download</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">remote</span><span class="p">:</span> <span class="n">DcmNode</span><span class="p">,</span>
        <span class="n">query_res</span><span class="p">:</span> <span class="n">QueryResult</span><span class="p">,</span>
        <span class="n">dest_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
        <span class="n">report</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RetrieveReport</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Uses `retrieve` method to download data and saves it to `dest_dir`&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Handle collisions/overwrites</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="n">dest_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span>
        <span class="n">out_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">query_res</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="p">):</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dest_dir</span> <span class="o">/</span> <span class="n">ds</span><span class="o">.</span><span class="n">SOPInstanceUID</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.dcm&quot;</span>
            <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="p">,</span>
                <span class="n">partial</span><span class="p">(</span><span class="n">pydicom</span><span class="o">.</span><span class="n">dcmwrite</span><span class="p">,</span> <span class="n">out_path</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">write_like_original</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">out_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_files</span></div>

<div class="viewcode-block" id="LocalEntity.upload"><a class="viewcode-back" href="../../dcm.net.html#dcm.net.LocalEntity.upload">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">remote</span><span class="p">:</span> <span class="n">DcmNode</span><span class="p">,</span>
        <span class="n">src_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">transfer_syntax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SOPList</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Uses `send` method to upload data from local `src_paths`&quot;&quot;&quot;</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span> <span class="n">transfer_syntax</span><span class="p">)</span> <span class="k">as</span> <span class="n">send_q</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">src_path</span> <span class="ow">in</span> <span class="n">src_paths</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uploading file: </span><span class="si">{</span><span class="n">src_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">pydicom</span><span class="o">.</span><span class="n">dcmread</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">src_path</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="n">send_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span></div>

    <span class="nd">@asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_associate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">remote</span><span class="p">:</span> <span class="n">DcmNode</span><span class="p">,</span>
        <span class="n">pres_contexts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PresentationContext</span><span class="p">],</span>
        <span class="n">query_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SOPClass</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Association</span><span class="p">]:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="n">assoc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ae</span><span class="o">.</span><span class="n">associate</span><span class="p">,</span>
            <span class="n">remote</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
            <span class="n">remote</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
            <span class="n">pres_contexts</span><span class="p">,</span>
            <span class="n">remote</span><span class="o">.</span><span class="n">ae_title</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">assoc</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FailedAssociationError</span><span class="p">(</span>
                <span class="s2">&quot;Failed to associate with remote: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">remote</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully associated with remote: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">remote</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">assoc</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">GeneratorExit</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">query_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">assoc</span><span class="o">.</span><span class="n">is_established</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sending c-cancel to remote: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">remote</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="p">,</span> <span class="n">assoc</span><span class="o">.</span><span class="n">send_c_cancel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">query_model</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Exception occured when sending c-cancel: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Releasing association&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="p">,</span> <span class="n">assoc</span><span class="o">.</span><span class="n">release</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prep_query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryLevel</span><span class="p">],</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">],</span>
        <span class="n">query_res</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryResult</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">QueryLevel</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Resolve/check `level` and `query` args for query methods&quot;&quot;&quot;</span>
        <span class="c1"># Build up our base query dataset</span>
        <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># Deterimine level if not specified, otherwise make sure it is valid</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">query_res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">default_level</span> <span class="o">=</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">STUDY</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">default_level</span> <span class="o">=</span> <span class="n">query_res</span><span class="o">.</span><span class="n">level</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">choose_level</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">default_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">QueryLevel</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown &#39;level&#39; for query: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">level</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">level</span><span class="p">,</span> <span class="n">query</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_fwd_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">evt</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">filt</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">filt</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calling async handler for </span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2"> event&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t find handler for the </span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2"> event&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mh">0x0122</span>

    <span class="k">def</span> <span class="nf">_setup_listen_mgr</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sync_cb</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">evt</span><span class="o">.</span><span class="n">Event</span><span class="p">],</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">presentation_contexts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PresentationContext</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting a threaded listener&quot;</span><span class="p">)</span>
        <span class="c1"># TODO: How to handle presentation contexts in generic way?</span>
        <span class="n">ae</span> <span class="o">=</span> <span class="n">AE</span><span class="p">(</span><span class="n">ae_title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">ae_title</span><span class="p">)</span>
        <span class="n">ae</span><span class="o">.</span><span class="n">dimse_timeout</span> <span class="o">=</span> <span class="mi">180</span>
        <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="n">presentation_contexts</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">context</span><span class="o">.</span><span class="n">abstract_syntax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">ae</span><span class="o">.</span><span class="n">add_supported_context</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">abstract_syntax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_ts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listen_mgr</span> <span class="o">=</span> <span class="n">ae</span><span class="o">.</span><span class="n">start_server</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">port</span><span class="p">),</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listen_mgr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">evt_type</span> <span class="ow">in</span> <span class="n">default_evt_pc_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Binding to event </span><span class="si">{</span><span class="n">evt_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_listen_mgr</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">evt_type</span><span class="p">,</span> <span class="n">sync_cb</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_cleanup_listen_mgr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cleaning up threaded listener&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listen_mgr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_listen_mgr</span><span class="o">.</span><span class="n">server_close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_listen_mgr</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Threaded listener shutdown successfully&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_listen_mgr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Threaded listener has been cleaned up&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_lock_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_filter</span><span class="p">:</span> <span class="n">EventFilter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>
        <span class="n">lock_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event_filter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lock_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lock_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span>
                <span class="s2">&quot;FilteredListenerLock&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">FilteredListenerLockBase</span><span class="p">,),</span>
                <span class="p">{</span><span class="s2">&quot;event_filter&quot;</span><span class="p">:</span> <span class="n">event_filter</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lock_types</span><span class="p">[</span><span class="n">event_filter</span><span class="p">]</span> <span class="o">=</span> <span class="n">lock_type</span>
        <span class="k">return</span> <span class="n">lock_type</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_single_report_builder</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">res_q</span><span class="p">:</span> <span class="n">janus</span><span class="o">.</span><span class="n">_AsyncQueueProxy</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]]],</span>
        <span class="n">report</span><span class="p">:</span> <span class="n">DicomOpReport</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">res_q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># if not report.done:</span>
                <span class="c1">#    assert report.n_input == 0</span>
                <span class="c1">#    report.done = True</span>
                <span class="k">break</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">data_set</span> <span class="o">=</span> <span class="n">res</span>
            <span class="n">report</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">data_set</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_multi_report_builder</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">res_q</span><span class="p">:</span> <span class="n">janus</span><span class="o">.</span><span class="n">_AsyncQueueProxy</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]]],</span>
        <span class="n">report</span><span class="p">:</span> <span class="n">MultiListReport</span><span class="p">[</span><span class="n">DicomOpReport</span><span class="p">],</span>
        <span class="n">def_report_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">curr_op_report</span> <span class="o">=</span> <span class="n">DicomOpReport</span><span class="p">(</span><span class="o">**</span><span class="n">def_report_attrs</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_op_report</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">res_q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;_multi_report_builder got an input&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;_multi_report_builder got None and is shutting down&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">curr_op_report</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_op_report</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">pass</span>
                        <span class="c1"># import pdb ; pdb.set_trace()</span>
                    <span class="n">curr_op_report</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">report</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">curr_op_report</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                <span class="n">curr_op_report</span> <span class="o">=</span> <span class="n">DicomOpReport</span><span class="p">(</span><span class="o">**</span><span class="n">def_report_attrs</span><span class="p">)</span>
                <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_op_report</span><span class="p">)</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">data_set</span> <span class="o">=</span> <span class="n">res</span>
            <span class="n">curr_op_report</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">data_set</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_choose_qr_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">remote</span><span class="p">:</span> <span class="n">DcmNode</span><span class="p">,</span> <span class="n">op_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">QueryLevel</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sop_class</span><span class="o">.</span><span class="n">SOPClass</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Pick an appropriate query model&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">PATIENT</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">query_model</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;PatientRoot&quot;</span><span class="p">,</span> <span class="s2">&quot;PatientStudyOnly&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">query_model</span> <span class="ow">in</span> <span class="n">remote</span><span class="o">.</span><span class="n">qr_models</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">QR_MODELS</span><span class="p">[</span><span class="n">query_model</span><span class="p">][</span><span class="n">op_type</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">UnsupportedQueryModelError</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">STUDY</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">query_model</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;StudyRoot&quot;</span><span class="p">,</span> <span class="s2">&quot;PatientRoot&quot;</span><span class="p">,</span> <span class="s2">&quot;PatientStudyOnly&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">query_model</span> <span class="ow">in</span> <span class="n">remote</span><span class="o">.</span><span class="n">qr_models</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">QR_MODELS</span><span class="p">[</span><span class="n">query_model</span><span class="p">][</span><span class="n">op_type</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">UnsupportedQueryModelError</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">query_model</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;StudyRoot&quot;</span><span class="p">,</span> <span class="s2">&quot;PatientRoot&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">query_model</span> <span class="ow">in</span> <span class="n">remote</span><span class="o">.</span><span class="n">qr_models</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">QR_MODELS</span><span class="p">[</span><span class="n">query_model</span><span class="p">][</span><span class="n">op_type</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">UnsupportedQueryModelError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_add_qr_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="p">:</span> <span class="n">BaseReport</span><span class="p">,</span> <span class="n">query_res</span><span class="p">:</span> <span class="n">QueryResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">report</span><span class="o">.</span><span class="n">_meta_data</span><span class="p">[</span><span class="s2">&quot;qr_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query_res</span><span class="o">.</span><span class="n">level</span>
        <span class="n">report</span><span class="o">.</span><span class="n">_meta_data</span><span class="p">[</span><span class="s2">&quot;patient_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">query_res</span><span class="o">.</span><span class="n">patients</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">query_res</span><span class="o">.</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">PATIENT</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">_meta_data</span><span class="p">[</span><span class="s2">&quot;study_uids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">query_res</span><span class="o">.</span><span class="n">studies</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">query_res</span><span class="o">.</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">QueryLevel</span><span class="o">.</span><span class="n">STUDY</span> <span class="ow">and</span> <span class="n">query_res</span><span class="o">.</span><span class="n">n_series</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">report</span><span class="o">.</span><span class="n">_meta_data</span><span class="p">[</span><span class="s2">&quot;series_uids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">query_res</span><span class="o">.</span><span class="n">series</span><span class="p">()]</span></div>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Brendan Moloney
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/furo.js"></script>
    </body>
</html>